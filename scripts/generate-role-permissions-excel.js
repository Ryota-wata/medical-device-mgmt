const XLSX = require('xlsx');
const path = require('path');

// 権限レベルの定義
const LEGEND = [
  ['記号', '意味'],
  ['F', 'フルアクセス（全操作可能）'],
  ['W', '閲覧 + 編集'],
  ['R', '閲覧のみ'],
  ['C', '作成 + 自分の申請の閲覧'],
  ['✕', 'アクセス不可'],
];

// ロール一覧
const ROLES = [
  ['ロール', 'ラベル', '所属', '説明'],
  ['admin', 'システム管理者', 'SHIP', 'システム全体の管理権限を持つ'],
  ['consultant', 'SHRCコンサル', 'SHIP', '担当施設の資産閲覧・個体管理リスト作成・タスク管理が主業務'],
  ['sales', 'GHS営業', 'SHIP', '閲覧のみ（営業活動のための情報確認用）'],
  ['office_admin', '事務管理者', '病院', '事務担当者の権限 + マスタ管理・ユーザー管理'],
  ['office_staff', '事務担当者', '病院', 'タスク管理画面での業務が中心'],
  ['clinical_staff', '臨床スタッフ', '病院', '現場での申請作成・点検実施・貸出実施'],
];

// 権限マトリクス
const PERMISSIONS = [
  ['カテゴリ', '機能', 'admin', 'consultant', 'sales', 'office_admin', 'office_staff', 'clinical_staff'],
  ['メイン画面', 'メイン画面表示', 'F', 'W', 'R', 'W', 'W', 'R'],
  ['', '', '', '', '', '', '', ''],
  ['資産関連', '資産検索・閲覧', 'F', 'R (担当施設)', 'R', 'W', 'R', 'R'],
  ['', '資産詳細表示', 'F', 'R (担当施設)', 'R', 'W', 'W', 'R'],
  ['', '資産編集', 'F', '✕', '✕', 'W', 'W', '✕'],
  ['', '個体管理リスト作成', 'F', 'W', '✕', '✕', '✕', '✕'],
  ['', '', '', '', '', '', '', ''],
  ['現有資産調査', 'オフライン準備', 'F', 'W', '✕', 'W', 'W', 'W'],
  ['', '調査場所選択', 'F', 'W', '✕', 'W', 'W', 'W'],
  ['', '資産調査入力', 'F', 'W', '✕', 'W', 'W', 'W'],
  ['', '調査履歴', 'F', 'W', '✕', 'W', 'W', 'W'],
  ['', '', '', '', '', '', '', ''],
  ['棚卸', '棚卸管理', 'F', 'W', '✕', 'W', 'W', 'R'],
  ['', '', '', '', '', '', '', ''],
  ['QRコード', 'QR発行', 'F', 'W', '✕', 'W', 'W', '✕'],
  ['', 'QR印刷', 'F', 'W', '✕', 'W', 'W', '✕'],
  ['', '', '', '', '', '', '', ''],
  ['購入管理', '見積書管理', 'F', '✕', 'R', 'W', 'W', '✕'],
  ['', '見積処理', 'F', '✕', 'R', 'W', 'W', '✕'],
  ['', '', '', '', '', '', '', ''],
  ['修理', '修理依頼（申請作成）', 'F', '✕', '✕', 'W', 'W', 'C'],
  ['', '修理タスク管理', 'F', 'W', 'R', 'W', 'W', '✕'],
  ['', '', '', '', '', '', '', ''],
  ['貸出', '貸出可能機器一覧', 'F', '✕', 'R', 'W', 'W', 'R'],
  ['', '貸出実施', 'F', '✕', '✕', 'W', 'W', 'W'],
  ['', '貸出タスク管理', 'F', 'W', 'R', 'W', 'W', '✕'],
  ['', '', '', '', '', '', '', ''],
  ['点検', '日常点検実施', 'F', '✕', '✕', 'W', 'W', 'W'],
  ['', '点検準備', 'F', 'W', '✕', 'W', 'W', '✕'],
  ['', '点検結果', 'F', 'W', '✕', 'W', 'W', 'R'],
  ['', '', '', '', '', '', '', ''],
  ['保守', '保守見積登録', 'F', '✕', 'R', 'W', 'W', '✕'],
  ['', 'メーカー保守結果', 'F', 'W', 'R', 'W', 'W', '✕'],
  ['', '', '', '', '', '', '', ''],
  ['廃棄', '廃棄タスク', 'F', 'W', '✕', 'W', 'W', '✕'],
  ['', '', '', '', '', '', '', ''],
  ['マスタ管理', '資産マスタ（SHIP）', 'F', 'R', '✕', '✕', '✕', '✕'],
  ['', '施設マスタ（SHIP）', 'F', 'R', '✕', '✕', '✕', '✕'],
  ['', '部門マスタ（SHIP）', 'F', 'R', '✕', '✕', '✕', '✕'],
  ['', '個別施設マスタ', 'F', 'R', '✕', 'W', 'R', '✕'],
  ['', '', '', '', '', '', '', ''],
  ['ユーザー管理', 'ユーザー管理', 'F', '✕', '✕', 'W (所属施設のみ)', '✕', '✕'],
  ['', '', '', '', '', '', '', ''],
  ['データ管理', '資産インポート', 'F', 'W', '✕', 'W', '✕', '✕'],
  ['', 'データマッチング', 'F', 'W', '✕', 'W', '✕', '✕'],
];

// メイン画面ボタン表示
const MAIN_BUTTONS = [
  ['ボタン', 'admin', 'consultant', 'sales', 'office_admin', 'office_staff', 'clinical_staff'],
  ['資産リスト', '○', '○', '○', '○', '○', '○'],
  ['編集リスト', '○', '○', '✕', '✕', '✕', '✕'],
  ['購入管理', '○', '✕', '○', '○', '○', '✕'],
  ['保守点検', '○', '✕', '✕', '○', '○', '○'],
  ['貸出管理', '○', '✕', '○', '○', '○', '○'],
  ['修理申請', '○', '✕', '✕', '○', '○', '○'],
  ['現有資産調査', '○', '○', '✕', '○', '○', '○'],
  ['マスタ管理', '○', '○', '✕', '○', '○', '✕'],
  ['ユーザー管理', '○', '✕', '✕', '○', '✕', '✕'],
];

// ロール別サマリー
const ROLE_SUMMARY = [
  ['ロール', 'できること', 'できないこと'],
  ['admin', '全機能へのフルアクセス', 'なし'],
  ['consultant',
    '・担当施設の資産閲覧\n・個体管理リスト作成\n・タスク管理画面（購入管理・購入見積依頼以外すべて）\n・現有資産調査フロー\n・棚卸管理\n・QRコード発行・印刷\n・資産インポート・データマッチング\n・SHIPマスタの閲覧',
    '・担当施設の資産編集\n・メイン画面の「保守点検」「貸出管理」「修理申請」\n・購入管理（見積書管理・見積処理）\n・ユーザー管理\n・個別施設マスタの編集'],
  ['sales',
    '・資産の閲覧\n・修理タスク・貸出タスクの閲覧\n・見積書管理・保守見積の閲覧',
    '・編集・作成系すべて\n・タスク管理画面での操作\n・マスタ管理\n・ユーザー管理\n・QRコード発行\n・現有資産調査\n・棚卸'],
  ['office_admin',
    '・事務担当者の全権限\n・個別施設マスタのCRUD（作成・編集・削除）\n・ユーザー管理（所属施設のユーザーのみ）',
    '・個体管理リスト作成\n・SHIPマスタの編集\n・資産インポート・データマッチング'],
  ['office_staff',
    '・タスク管理画面での業務（購入管理、修理タスク、貸出タスク、点検、保守、廃棄）\n・資産詳細の編集\n・現有資産調査フロー\n・棚卸管理\n・QRコード発行・印刷\n・個別施設マスタの閲覧',
    '・個体管理リスト作成\n・マスタ管理（編集）\n・ユーザー管理\n・資産インポート・データマッチング'],
  ['clinical_staff',
    '・各種申請の作成 + 自分の申請の閲覧（修理依頼など）\n・点検実施（日常点検）\n・貸出実施\n・現有資産調査フロー\n・資産の閲覧\n・棚卸の閲覧\n・点検結果の閲覧\n・貸出可能機器の閲覧',
    '・タスク管理画面へのアクセス\n・個体管理リスト作成\n・資産編集\n・QRコード発行\n・マスタ管理\n・ユーザー管理\n・購入管理\n・保守管理\n・廃棄タスク'],
];

// ワークブック作成
const wb = XLSX.utils.book_new();

// シート1: 権限マトリクス
const ws1 = XLSX.utils.aoa_to_sheet(PERMISSIONS);
ws1['!cols'] = [
  { wch: 15 },  // カテゴリ
  { wch: 25 },  // 機能
  { wch: 12 },  // admin
  { wch: 15 },  // consultant
  { wch: 12 },  // sales
  { wch: 18 },  // office_admin
  { wch: 12 },  // office_staff
  { wch: 12 },  // clinical_staff
];
XLSX.utils.book_append_sheet(wb, ws1, '権限マトリクス');

// シート2: ロール一覧
const ws2 = XLSX.utils.aoa_to_sheet(ROLES);
ws2['!cols'] = [
  { wch: 15 },
  { wch: 18 },
  { wch: 10 },
  { wch: 50 },
];
XLSX.utils.book_append_sheet(wb, ws2, 'ロール一覧');

// シート3: メイン画面ボタン
const ws3 = XLSX.utils.aoa_to_sheet(MAIN_BUTTONS);
ws3['!cols'] = [
  { wch: 15 },
  { wch: 10 },
  { wch: 12 },
  { wch: 10 },
  { wch: 12 },
  { wch: 12 },
  { wch: 12 },
];
XLSX.utils.book_append_sheet(wb, ws3, 'メイン画面ボタン');

// シート4: ロール別サマリー
const ws4 = XLSX.utils.aoa_to_sheet(ROLE_SUMMARY);
ws4['!cols'] = [
  { wch: 15 },
  { wch: 60 },
  { wch: 60 },
];
XLSX.utils.book_append_sheet(wb, ws4, 'ロール別サマリー');

// シート5: 凡例
const ws5 = XLSX.utils.aoa_to_sheet(LEGEND);
ws5['!cols'] = [
  { wch: 10 },
  { wch: 30 },
];
XLSX.utils.book_append_sheet(wb, ws5, '凡例');

// ファイル出力
const outputPath = path.join(__dirname, '..', 'docs', 'role-permissions.xlsx');
XLSX.writeFile(wb, outputPath);

console.log(`Excel file created: ${outputPath}`);
